<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>çˆ·çˆ·çš„é»„é‡‘çŸ¿å·¥ - ä¼šç®—è´¦ç‰ˆ</title>
    <style>
        :root {
            --bg-color: #3E2723;
            --ui-bg: #5D4037;
            --text-gold: #FFD54F;
        }

        body {
            margin: 0; padding: 0;
            background-color: var(--bg-color);
            font-family: "Microsoft YaHei", sans-serif;
            overflow: hidden; touch-action: none;
            display: flex; flex-direction: column; height: 100vh;
        }

        /* é¡¶éƒ¨æ  */
        #top-bar {
            height: 100px; /* åŠ é«˜ä¸€ç‚¹ï¼Œè®©å­—æ›´å¤§ */
            background-color: var(--ui-bg);
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 30px; border-bottom: 6px solid #8D6E63; z-index: 10;
        }

        .score-box { display: flex; flex-direction: column; align-items: flex-start; }
        .label { font-size: 1.8rem; color: #D7CCC8; font-weight: bold; }
        /* è¿™é‡Œçš„å­—ä½“ç”¨ç­‰å®½å­—ä½“ï¼Œæ•°å­—è·³åŠ¨æ›´å¥½çœ‹ */
        .value { font-size: 3.5rem; color: var(--text-gold); font-weight: 900; font-family: "Courier New", monospace; }

        canvas {
            display: block; width: 100%; flex: 1;
            background: repeating-linear-gradient(45deg, #3E2723, #3E2723 20px, #4E342E 20px, #4E342E 40px);
        }

        /* çˆ·çˆ·å’ŒçŒ´å­åŒºåŸŸ */
        #miner-area {
            position: absolute; top: 100px; left: 50%; transform: translateX(-50%);
            display: flex; align-items: flex-end; justify-content: center;
            width: 300px; height: 100px; pointer-events: none; z-index: 5;
        }

        .char { font-size: 7rem; transition: transform 0.2s; line-height: 1; }
        #grandpa { margin-right: 20px; position: relative; top: 15px; }
        
        #monkey-dom { font-size: 5rem; opacity: 0.9; transform: scaleX(-1); position: relative; bottom: 5px; }

        /* å¼¹çª— */
        #modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            display: flex; justify-content: center; align-items: center; z-index: 100;
        }
        
        .modal-content {
            background: #FFF8E1; padding: 40px; border-radius: 40px;
            text-align: center; border: 10px solid #FF6F00;
            width: 85%; max-width: 600px;
        }

        h2 { font-size: 4rem; margin: 0 0 20px 0; color: #BF360C; }
        p { font-size: 2.2rem; color: #5D4037; margin-bottom: 30px; font-weight: bold;}

        .btn {
            background: #FF6F00; color: white; border: none; padding: 25px 0;
            font-size: 3rem; font-weight: bold; border-radius: 60px; cursor: pointer;
            box-shadow: 0 10px 0 #E65100; width: 100%;
        }
        .btn:active { transform: translateY(10px); box-shadow: none; }

        /* é£˜åˆ†ç‰¹æ•ˆ */
        .float-score {
            position: absolute; font-size: 4.5rem; font-weight: 900; color: #FFFF00;
            text-shadow: 4px 4px 0 #000; pointer-events: none;
            animation: floatUp 1.2s forwards; z-index: 20;
        }
        @keyframes floatUp {
            0% { transform: translateY(0) scale(1); opacity: 1; }
            50% { transform: translateY(-80px) scale(1.2); opacity: 1; }
            100% { transform: translateY(-150px) scale(1); opacity: 0; }
        }

        /* çŒ´å­æ¸…åœºå–Šè¯ */
        #shout-bubble {
            position: absolute; top: 220px; left: 50%; transform: translateX(-50%);
            background: white; padding: 15px 30px; border-radius: 30px;
            font-size: 2.5rem; font-weight: bold; color: #D84315;
            display: none; border: 5px solid #FF6F00; z-index: 30;
            animation: pop 0.5s infinite alternate; white-space: nowrap;
        }
        @keyframes pop { from{transform: translateX(-50%) scale(1);} to{transform: translateX(-50%) scale(1.1);} }

    </style>
</head>
<body>

<div id="top-bar">
    <div class="score-box">
        <span class="label">ç›®æ ‡åˆ†æ•°</span>
        <span class="value" id="target-score">500</span>
    </div>
    <div class="score-box" style="align-items: flex-end;">
        <span class="label">å½“å‰å¾—åˆ†</span>
        <span class="value" id="current-score">0</span>
    </div>
</div>

<div id="miner-area">
    <div class="char" id="grandpa">ğŸ‘´</div>
    <div style="position:absolute; bottom:0; width:180px; height:60px; background:#555; border-radius:15px; z-index:-1;"></div>
    <div class="char" id="monkey-dom">ğŸµ</div>
</div>

<div id="shout-bubble">çˆ·çˆ·æˆ‘æ¥å•¦ï¼</div>
<canvas id="gameCanvas"></canvas>

<div id="modal">
    <div class="modal-content" id="start-screen">
        <h2>ğŸ‘´ å¿«ä¹çŸ¿å·¥</h2>
        <p>æ»¡åœ°å®è´ï¼Œæ…¢æ…¢æŠ“ï¼<br>åˆ†æ•°ä¼šè‡ªåŠ¨ç®—å¥½ï¼</p>
        <button class="btn" onclick="startGame()">å¼€å§‹å‘è´¢</button>
    </div>
    <div class="modal-content" id="level-screen" style="display:none;">
        <h2 id="level-title">å¤§ä¸°æ”¶ï¼</h2>
        <p id="level-msg">çˆ·çˆ·çœŸå‰å®³ï¼</p>
        <button class="btn" onclick="nextLevel()">ä¸‹ä¸€å…³</button>
    </div>
</div>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    
    let width, height;
    let hookX, hookY; 
    
    // æ ¸å¿ƒåˆ†æ•°å˜é‡ï¼ˆç¡®ä¿æ˜¯æ•°å­— Numberï¼‰
    let score = 0;
    let displayScore = 0; // ç”¨äºæ»šåŠ¨çš„æ˜¾ç¤ºåˆ†æ•°
    let targetScore = 500;
    
    let level = 1;
    let gameState = 'STOP'; 
    
    // é’©å­å‚æ•° - æ…¢é€Ÿç‰ˆ
    let angle = 0;
    let angleSpeed = 0.015; 
    let angleDir = 1; 
    let hookLen = 80; 
    let maxLen = 0;
    let hookSpeed = 8; 
    let caughtItem = null;

    // çŒ´å­æ¸…åœº
    let monkeyX = 0;
    let monkeyY = 0;
    let monkeyTarget = null;
    let monkeySpeed = 18; 

    let items = [];
    
    // å¥–å“åº“ï¼šæ³¨æ„ score å…¨éƒ¨æ˜¯æ•°å­—ï¼Œ? æ”¹ä¸º 0 (é€»è¾‘ä¸­åŠ¨æ€ç”Ÿæˆ)
    const TYPES = {
        GOLD_XL: { score: 800, weight: 3, size: 70, emoji: 'ğŸ’°' },    
        GOLD_L:  { score: 500, weight: 2, size: 60, emoji: 'ğŸŒ•' },    
        INGOT:   { score: 666, weight: 4, size: 55, emoji: 'ğŸ§ˆ' },    
        DIAMOND: { score: 999, weight: 8, size: 40, emoji: 'ğŸ’' },    
        PEACH:   { score: 200, weight: 5, size: 50, emoji: 'ğŸ‘' },    
        BAG:     { score: 0,   weight: 5, size: 50, emoji: 'ğŸ§§' },    // 0ä»£è¡¨éšæœº
        GIFT:    { score: 0,   weight: 5, size: 55, emoji: 'ğŸ' },    
        CABBAGE: { score: 300, weight: 4, size: 60, emoji: 'ğŸ¥¬' },    
        STONE:   { score: 20,  weight: 1, size: 45, emoji: 'ğŸª¨' }     
    };

    function init() {
        resize();
        window.addEventListener('resize', resize);
        canvas.addEventListener('touchstart', launchHook, {passive: false});
        canvas.addEventListener('mousedown', launchHook);
    }

    function resize() {
        width = canvas.width = canvas.parentElement.clientWidth;
        height = canvas.height = canvas.parentElement.clientHeight;
        hookX = width / 2;
        hookY = 70; 
        maxLen = Math.sqrt(width*width + height*height);
    }

    function generateLevel(lvl) {
        items = [];
        const addItem = (typeDef) => {
            let item = { ...typeDef };
            item.x = Math.random() * (width - 100) + 50;
            item.y = Math.random() * (height - 400) + 280; 
            item.active = true;
            // ç¡®ä¿åˆ†æ•°æ˜¯æ•°å­—
            item.score = Number(item.score); 
            items.push(item);
        };

        // å®ç‰©é“ºæ»¡
        for(let i=0; i<4; i++) addItem(TYPES.GOLD_XL); 
        for(let i=0; i<3; i++) addItem(TYPES.INGOT);   
        for(let i=0; i<3; i++) addItem(TYPES.BAG);     
        for(let i=0; i<2; i++) addItem(TYPES.PEACH);   
        for(let i=0; i<2; i++) addItem(TYPES.GIFT);    
        if(Math.random() > 0.5) addItem(TYPES.CABBAGE); 
        for(let i=0; i<lvl; i++) addItem(TYPES.DIAMOND);
        for(let i=0; i<2; i++) addItem(TYPES.STONE);
    }

    function loop() {
        if (gameState === 'STOP') return;
        update();
        draw();
        updateScoreAnimation(); // æ¯ä¸€å¸§éƒ½æ›´æ–°åˆ†æ•°çš„æ»šåŠ¨åŠ¨ç”»
        requestAnimationFrame(loop);
    }

    // --- åˆ†æ•°æ»šåŠ¨ç‰¹æ•ˆé€»è¾‘ ---
    function updateScoreAnimation() {
        if (displayScore < score) {
            // å¦‚æœæ˜¾ç¤ºçš„å°‘äºå®é™…çš„ï¼Œå°±åŠ ä¸€ç‚¹
            let step = Math.ceil((score - displayScore) / 10);
            displayScore += step;
            document.getElementById('current-score').innerText = displayScore;
        } else {
            // ç¡®ä¿æœ€åä¸€è‡´
            displayScore = score;
            document.getElementById('current-score').innerText = displayScore;
        }
    }

    function update() {
        if (gameState === 'SWEEP') {
            updateMonkeySweep();
            return;
        }

        if (gameState === 'IDLE') {
            angle += angleSpeed * angleDir;
            if (angle > 1.3 || angle < -1.3) angleDir *= -1;
        } 
        else if (gameState === 'EXTEND') {
            hookLen += hookSpeed;
            let curX = hookX + Math.sin(angle) * hookLen;
            let curY = hookY + Math.cos(angle) * hookLen;
            
            if (curX < 0 || curX > width || curY > height) {
                gameState = 'RETRACT';
            }
            
            for (let item of items) {
                if (!item.active) continue;
                let dist = Math.hypot(curX - item.x, curY - item.y);
                if (dist < item.size + 30) { // åˆ¤å®šè¶…å¤§
                    caughtItem = item;
                    item.active = false; 
                    gameState = 'RETRACT';
                    document.getElementById('monkey-dom').innerText = "ğŸ™Œ";
                    break;
                }
            }
        } 
        else if (gameState === 'RETRACT') {
            let speed = hookSpeed;
            if (caughtItem) {
                // ç¡®ä¿weightæ˜¯æ•°å­—è¿ç®—
                speed = hookSpeed * (caughtItem.weight / 6); 
                if (speed < 4) speed = 4; 
            }
            hookLen -= speed;
            if (hookLen <= 70) {
                hookLen = 70;
                gameState = 'IDLE';
                if (caughtItem) {
                    processCatch(caughtItem);
                    caughtItem = null;
                    document.getElementById('monkey-dom').innerText = "ğŸµ"; 
                }
                checkRemainingItems();
            }
        }
    }

    function checkRemainingItems() {
        // è®¡ç®—å‰©ä¸‹è¿˜æœ‰å¤šå°‘ä¸ªâ€œå¥½ä¸œè¥¿â€
        let activeCount = items.filter(i => i.active && (i.score > 20 || i.score === 0)).length;
        
        if (activeCount > 0 && activeCount <= 5) {
            startMonkeySweep();
        } else if (activeCount === 0) {
            setTimeout(winLevel, 1500); // ç­‰åˆ†æ•°æ»šå®Œå†èµ¢
        }
    }

    function startMonkeySweep() {
        gameState = 'SWEEP';
        document.getElementById('monkey-dom').style.opacity = '0';
        const bubble = document.getElementById('shout-bubble');
        bubble.style.display = 'block';
        setTimeout(() => bubble.style.display = 'none', 2000);
        
        monkeyX = width / 2 + 100;
        monkeyY = 120;
        monkeyTarget = null;
    }

    function updateMonkeySweep() {
        if (!monkeyTarget) {
            let minDist = Infinity;
            for (let item of items) {
                if (item.active && (item.score > 20 || item.score === 0)) { 
                    let dist = Math.hypot(monkeyX - item.x, monkeyY - item.y);
                    if (dist < minDist) {
                        minDist = dist;
                        monkeyTarget = item;
                    }
                }
            }
            
            if (!monkeyTarget) {
                // å›å®¶
                let distHome = Math.hypot(monkeyX - (width/2+100), monkeyY - 120);
                if (distHome < 30) {
                    document.getElementById('monkey-dom').style.opacity = '0.9';
                    setTimeout(winLevel, 1000);
                    gameState = 'STOP'; 
                } else {
                    let angleToHome = Math.atan2(120 - monkeyY, (width/2+100) - monkeyX);
                    monkeyX += Math.cos(angleToHome) * monkeySpeed;
                    monkeyY += Math.sin(angleToHome) * monkeySpeed;
                }
                return;
            }
        }

        if (monkeyTarget) {
            let dx = monkeyTarget.x - monkeyX;
            let dy = monkeyTarget.y - monkeyY;
            let dist = Math.hypot(dx, dy);
            
            if (dist < monkeySpeed) {
                monkeyX = monkeyTarget.x;
                monkeyY = monkeyTarget.y;
                monkeyTarget.active = false;
                processCatch(monkeyTarget); 
                monkeyTarget = null; 
            } else {
                let angleToItem = Math.atan2(dy, dx);
                monkeyX += Math.cos(angleToItem) * monkeySpeed;
                monkeyY += Math.sin(angleToItem) * monkeySpeed;
            }
        }
    }

    function processCatch(item) {
        // å¼ºåˆ¶è½¬æ¢æ•°å­—ï¼Œé˜²æ­¢æ‹¼æ¥
        let val = Number(item.score);
        
        // å¦‚æœæ˜¯0ï¼ˆç›²ç›’ï¼‰ï¼Œç”Ÿæˆéšæœºæ•°
        if (val === 0) {
            val = Math.floor(Math.random() * 600) + 200; 
        }
        
        // æ•°å­¦åŠ æ³•
        score = score + val;
        
        // é£˜åˆ†ç‰¹æ•ˆ
        showFloatText(`+${val}`, width/2, 250);
        
        if(navigator.vibrate) navigator.vibrate(100);
        try { new Audio('https://assets.mixkit.co/active_storage/sfx/2000/2000-preview.mp3').play(); } catch(e){}
    }
    
    function showFloatText(text, x, y) {
        const el = document.createElement('div');
        el.className = 'float-score';
        el.innerText = text;
        el.style.left = x + 'px';
        el.style.top = y + 'px';
        el.style.transform = "translateX(-50%)"; 
        document.body.appendChild(el);
        setTimeout(() => el.remove(), 1200);
    }

    function draw() {
        ctx.clearRect(0, 0, width, height);
        
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        for (let item of items) {
            if (item.active) {
                ctx.font = `${item.size * 1.8}px Arial`; 
                ctx.fillText(item.emoji, item.x, item.y);
            }
        }
        
        if (gameState !== 'SWEEP') {
            let endX = hookX + Math.sin(angle) * hookLen;
            let endY = hookY + Math.cos(angle) * hookLen;
            
            ctx.beginPath();
            ctx.moveTo(hookX, hookY);
            ctx.lineTo(endX, endY);
            ctx.lineWidth = 8;
            ctx.strokeStyle = "#5D4037";
            ctx.stroke();
            
            ctx.save();
            ctx.translate(endX, endY);
            ctx.rotate(-angle);
            ctx.fillStyle = "#795548";
            ctx.beginPath();
            ctx.arc(0, 0, 18, 0, Math.PI*2);
            ctx.fill();
            ctx.lineWidth = 10;
            ctx.strokeStyle = "#8D6E63";
            ctx.lineCap = "round";
            ctx.beginPath();
            ctx.moveTo(-5, 0); ctx.bezierCurveTo(-35, 10, -35, 45, -5, 35);
            ctx.moveTo(5, 0); ctx.bezierCurveTo(35, 10, 35, 45, 5, 35);
            ctx.stroke();
            if (caughtItem) {
                ctx.font = `${caughtItem.size * 1.8}px Arial`;
                ctx.rotate(angle);
                ctx.fillText(caughtItem.emoji, 0, 55); 
            }
            ctx.restore();
        } else {
            ctx.beginPath(); ctx.moveTo(hookX, hookY); ctx.lineTo(hookX, hookY+60);
            ctx.lineWidth=8; ctx.strokeStyle="#5D4037"; ctx.stroke();
        }

        if (gameState === 'SWEEP') {
            ctx.font = "6rem Arial";
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            ctx.fillText("ğŸµ", monkeyX, monkeyY);
        }
    }

    function launchHook(e) {
        if(e) e.preventDefault();
        if (gameState === 'IDLE') {
            gameState = 'EXTEND';
        }
    }

    function startGame() {
        document.getElementById('modal').style.display = 'none';
        document.getElementById('start-screen').style.display = 'none';
        document.getElementById('level-screen').style.display = 'block'; 
        
        score = 0;
        displayScore = 0;
        level = 1;
        targetScore = 500;
        
        document.getElementById('current-score').innerText = 0;
        document.getElementById('target-score').innerText = targetScore;
        
        startNewLevel();
    }
    
    function nextLevel() {
        document.getElementById('modal').style.display = 'none';
        level++;
        // ç›®æ ‡åˆ†æ•°ä¹Ÿä¼šä¸Šæ¶¨
        targetScore += 1000; 
        document.getElementById('target-score').innerText = targetScore;
        startNewLevel();
    }

    function startNewLevel() {
        document.getElementById('monkey-dom').style.opacity = '0.9'; 
        gameState = 'IDLE';
        hookLen = 70; angle = 0;
        generateLevel(level);
        loop();
    }
    
    function winLevel() {
        gameState = 'STOP';
        document.getElementById('modal').style.display = 'flex';
        document.getElementById('level-title').innerText = `ç¬¬ ${level} å…³ä¸°æ”¶ï¼`;
        document.getElementById('level-msg').innerText = `ç›®å‰å¾—åˆ†ï¼š${score}`;
    }

    init();

</script>
</body>
</html>